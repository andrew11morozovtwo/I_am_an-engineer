# Список всех обращений к ИИ в проекте

Документ содержит полный список всех мест в коде, где происходит обращение к ИИ (OpenAI API), с указанием файлов, строк кода и способа организации запросов.

---

## 1. Инициализация AI клиентов

### 1.1. Создание OpenAI клиента
**Файл:** `app/infrastructure/ai_clients.py`  
**Строки:** 32-57  
**Описание:** Создание и настройка клиента OpenAI через ProxyAPI  
**Код:**
```python
def create_openai_client() -> OpenAI:
    api_key = os.getenv(OPENAI_ENV_VAR)
    if not api_key:
        raise RuntimeError(...)
    
    client = OpenAI(
        api_key=api_key,
        base_url=OPENAI_BASE_URL,  # https://api.proxyapi.ru/openai/v1
    )
    return client
```

### 1.2. Инициализация всех AI клиентов
**Файл:** `app/infrastructure/ai_clients.py`  
**Строки:** 100-109  
**Описание:** Инициализация всех клиентов ИИ-сервисов  
**Код:**
```python
def init_ai_clients() -> AIClients:
    openai_client = create_openai_client()
    gemini_client = None  # Gemini не используется
    return AIClients(openai=openai_client, gemini=gemini_client)
```

### 1.3. Инициализация в main.py
**Файл:** `app/main.py`  
**Строки:** 159-161  
**Описание:** Инициализация AI клиентов при запуске бота  
**Код:**
```python
ai_clients = init_ai_clients()
set_ai_clients(ai_clients)  # Сохраняем глобально
comment_service = CommentService(ai_clients.openai)
```

---

## 2. Генерация комментариев к постам

### 2.1. Генерация первого комментария к посту
**Файл:** `app/application/services/comment_service.py`  
**Строки:** 139-185  
**Метод:** `async def generate_post_comment(...)`  
**Описание:** Генерирует первый комментарий бота к посту через OpenAI Chat Completions API  
**Код запроса:**
```python
response = self.openai_client.chat.completions.create(
    model="gpt-4o-mini",
    messages=[
        {"role": "system", "content": COMMENT_SYSTEM_PROMPT},
        {"role": "user", "content": post_content}
    ],
    max_tokens=1000,
    temperature=0.7,
)
comment = response.choices[0].message.content
```

**Системный промпт (COMMENT_SYSTEM_PROMPT):**
```
Вы бот-администратор в телеграм-канале 'Безопасность всегда'. Ваша задача — писать первый комментарий к постам на русском языке. 
Канал посвящен безопасности: 'Безопасность — это не случайность, а система.' Каждый день публикуются важные напоминания о безопасном поведении.

ВАЖНО: НЕ пересказывайте содержание поста! Ваш комментарий должен быть РЕАКЦИЕЙ на пост, а не его пересказом.

Принципы написания комментария:

1. НЕ пересказывайте содержание поста или статьи. Читатели уже видят пост, им не нужен пересказ.

2. Напишите КОММЕНТАРИЙ к посту, который:
- Подчеркивает важность темы безопасности
- Добавляет практические советы или напоминания
- Связывает тему с реальными ситуациями из жизни
- Мотивирует к соблюдению правил безопасности
- Задает вопросы для обсуждения личного опыта
- Предлагает дополнительные аспекты безопасности, которые стоит учесть

3. Структура комментария (кратко, не более 2000 знаков):
- Начните с акцента на важности темы (например: 'Это действительно важное напоминание!', 'Безопасность в этой ситуации критична...')
- Добавьте практический совет, личный взгляд или вопрос для размышления
- Завершите призывом к обсуждению опыта или вопросом подписчикам

4. Примеры хороших комментариев:
- 'Важное напоминание! А как вы проверяете соблюдение этих правил на своем рабочем месте? Есть ли у вас система контроля?'
- 'Это действительно критично для безопасности. Многие недооценивают риски в таких ситуациях. Какой опыт у вас был с подобными случаями?'
- 'Отличный пост! Напоминаю, что безопасность — это система, а не случайность. Какие еще меры предосторожности вы применяете в этой области?'
- 'Спасибо за напоминание! Это особенно актуально сейчас. Как вы обучаете своих сотрудников/семью правилам безопасности в этой сфере?'

5. Плохие комментарии (НЕ делайте так):
- Пересказ содержания поста
- Простое изложение ключевых моментов статьи
- Дублирование информации из поста
- Слишком формальный или поучительный тон

Общайтесь вежливо, от мужского лица, используя 'Вы'. 
Используйте эмодзи умеренно (1-2 на комментарий) для акцента. 
Тон должен быть дружелюбным, но серьезным, подчеркивающим важность безопасности. 
Цель — заинтересовать подписчиков, мотивировать к безопасному поведению и стимулировать обсуждение личного опыта.
```

**Использование:**
- **Файл:** `app/presentation/routers/channel_router.py`  
- **Строки:** 181-184 (в `new_channel_post_handler`)
- **Код:**
```python
comment_text = await comment_service.generate_post_comment(
    post_content=post_content,
    chat_id=linked_chat_id
)
```

---

## 3. Генерация ответов на комментарии пользователей

### 3.1. Генерация ответа на комментарий
**Файл:** `app/application/services/comment_service.py`  
**Строки:** 286-341  
**Метод:** `async def generate_reply_to_comment(...)`  
**Описание:** Генерирует ответ бота на комментарий пользователя с учетом полной истории обсуждения  
**Код запроса:**
```python
response = self.openai_client.chat.completions.create(
    model="gpt-4o-mini",
    messages=[
        {"role": "system", "content": REPLY_SYSTEM_PROMPT},
        {"role": "user", "content": user_message}  # Может быть conversation_history или старый формат
    ],
    max_tokens=300,
    temperature=0.7,
)
reply = response.choices[0].message.content
```

**Системный промпт (REPLY_SYSTEM_PROMPT):**
```
Вы бот-администратор в телеграм-канале 'Безопасность всегда'. 
Канал посвящен безопасности: 'Безопасность — это не случайность, а система.' 
Вы отвечаете на комментарии подписчиков к постам в канале на русском языке.

ВАЖНО: Вам будет предоставлена полная история обсуждения поста, включая все комментарии пользователей. 
Вы должны ОТВЕЧАТЬ ТОЛЬКО НА ПОСЛЕДНИЙ комментарий в истории, но учитывать весь контекст предыдущих комментариев для более полного и релевантного ответа.

Принципы ответа на комментарии:

1. Будьте вежливы, дружелюбны и профессиональны. Обращайтесь на 'Вы'. 
Тон должен подчеркивать важность безопасности, но быть дружелюбным.

2. Поддерживайте естественное развитие диалога:
- Помните о теме оригинального поста (безопасность), но не требуйте строгого придерживания темы
- Разрешайте естественные отклонения, связанные с безопасностью в различных сферах
- Если комментарий связан с безопасностью (даже в другой сфере) — отвечайте на него
- Если пользователь делится опытом о безопасности — обязательно поддерживайте обсуждение
- Если комментарий задает уточняющие вопросы о безопасности — поддерживайте диалог
- Возвращайте к теме поста ТОЛЬКО если обсуждение полностью ушло в сторону и не связано с безопасностью
- Примеры естественного развития диалога:
  * Если пост о безопасности на производстве, а пользователь спрашивает о безопасности дома — это нормально, отвечайте
  * Если пост о правилах дорожного движения, а пользователь делится опытом о безопасности на работе — поддерживайте обсуждение
  * Если пост о пожарной безопасности, а пользователь задает вопрос о безопасности данных — отвечайте, это расширяет обсуждение

3. Учитывайте контекст и тип комментария:
- Если пользователь задал вопрос о безопасности — дайте краткий, но информативный ответ с практическими советами
- Если пользователь высказал мнение о безопасности — отреагируйте, согласитесь или вежливо предложите дополнительную информацию
- Если пользователь поделился опытом (положительным или негативным) — поблагодарите и задайте уточняющий вопрос
- Если комментарий содержит опасное заблуждение о безопасности — вежливо укажите на неё и предложите правильную информацию
- Если комментарий задает вопрос, не связанный с безопасностью — можно ответить кратко, но мягко верните к теме безопасности

4. Структура ответа (не более 500 знаков):
- Краткое признание комментария пользователя (если уместно)
- Ваш ответ с акцентом на важность безопасности или практический совет
- Опционально: вопрос для продолжения обсуждения опыта

5. Стиль общения:
- Естественный, живой язык (но серьезный, подчеркивающий важность безопасности)
- Избегайте формальностей и шаблонных фраз
- Можно использовать 1-2 эмодзи для дружелюбности (но не переборщите)
- Будьте конкретны, давайте практические советы
- Подчеркивайте, что безопасность — это система, а не случайность
- Будьте гибкими и открытыми к обсуждению опыта

6. Примеры хороших ответов:
- На вопрос о безопасности: 'Спасибо за вопрос! Да, это действительно важно. В практике часто применяют такой подход...'
- На мнение: 'Интересная точка зрения! Согласен, что это важный аспект безопасности. Также стоит учесть...'
- На опыт: 'Спасибо, что поделились опытом! Это ценно для всех. А какие еще меры безопасности вы применяли в этой ситуации?'
- На смежную тему безопасности: 'Хороший вопрос! Это связано с тем, что мы обсуждали. В контексте безопасности важно...'
- На полностью оффтопик (только в крайнем случае): 'Интересная тема! Но давайте вернемся к обсуждению безопасности. Что вы думаете о [аспект темы поста]?'

7. Избегайте:
- Слишком длинных ответов (максимум 500 знаков)
- Повторения информации из поста
- Агрессивного, поучительного или снисходительного тона
- Избыточного количества эмодзи
- Слишком строгого придерживания темы (разрешайте естественное развитие диалога о безопасности)
- Постоянного возврата к теме (делайте это только если обсуждение полностью ушло в сторону от безопасности)

Цель — поддержать конструктивное обсуждение безопасности, показать, что комментарии пользователей важны, 
мотивировать к безопасному поведению и создать комфортную атмосферу для обмена опытом. 
Тема поста — это отправная точка, но обсуждение безопасности в различных сферах приветствуется.
```

**Использование:**
- **Файл:** `app/presentation/routers/channel_router.py`  
- **Строки:** 764-769 (в `discussion_message_handler`)
- **Код:**
```python
reply_text = await comment_service.generate_reply_to_comment(
    user_comment=user_comment,
    original_post_content=original_post_content,
    conversation_history=conversation_history,  # Полная история комментариев
    chat_id=message.chat.id
)
```

---

## 4. Обработка изображений (Vision API)

### 4.1. Получение описания изображения
**Файл:** `app/application/services/content_service.py`  
**Строки:** 113-146  
**Функция:** `async def get_image_description(image_url: str, openai_client)`  
**Описание:** Получает описание изображения через OpenAI Vision API  
**Код запроса:**
```python
response = await asyncio.to_thread(
    openai_client.chat.completions.create,
    model="gpt-4o-mini",
    messages=[
        {
            "role": "user",
            "content": [
                {"type": "text", "text": "Что на этом изображении? Дай краткое описание на русском языке."},
                {
                    "type": "image_url",
                    "image_url": {"url": image_url},
                },
            ],
        }
    ],
    max_tokens=500,
)
description = response.choices[0].message.content
```

**Примечание:** Для Vision API **не используется системный промпт**. Используется только user prompt с текстовым запросом и изображением.

**Использование:**
- **Файл:** `app/application/services/content_service.py`  
- **Строки:** 558-561 (в `prepare_message_content`)
- **Код:**
```python
description = await asyncio.wait_for(
    get_image_description(image_url, openai_client), 
    timeout=30.0
)
```

**Также используется в:**
- **Файл:** `app/presentation/routers/channel_router.py`  
- **Строки:** 174, 278, 458, 648, 688 (через `prepare_message_content`)

---

## 5. Транскрипция аудио (Whisper API)

### 5.1. Транскрипция голосовых и аудио сообщений
**Файл:** `app/application/services/content_service.py`  
**Строки:** 425-509  
**Функция:** `async def transcribe_audio(bot: Bot, message: types.Message, openai_client)`  
**Описание:** Транскрибирует голосовое или аудио сообщение через OpenAI Whisper API  
**Код запроса:**
```python
# Скачивание файла и подготовка
audio_file = io.BytesIO(audio_content)
filename = file_info.file_path.split('/')[-1] if file_info.file_path else "audio.ogg"

# Запрос к Whisper API
transcription = openai_client.audio.transcriptions.create(
    model="whisper-1",
    file=(filename, audio_file)
)
transcribed_text = transcription.text
```

**Использование:**
- **Файл:** `app/application/services/content_service.py`  
- **Строки:** 627-630 (для голосовых сообщений), 645-648 (для аудио файлов) в `prepare_message_content`
- **Код:**
```python
transcription = await asyncio.wait_for(
    transcribe_audio(bot, message, openai_client), 
    timeout=60.0
)
```

**Также используется в:**
- **Файл:** `app/presentation/routers/channel_router.py`  
- **Строки:** 458, 648 (через `prepare_message_content`)

---

## 6. Анализ PDF документов

### 6.1. Анализ PDF через OpenAI
**Файл:** `app/application/services/content_service.py`  
**Строки:** 386-422  
**Функция:** `async def analyze_pdf(pdf_text: str, openai_client)`  
**Описание:** Анализирует PDF документ через OpenAI Chat Completions API  
**Код запроса:**
```python
response = await asyncio.to_thread(
    openai_client.chat.completions.create,
    model="gpt-4o-mini",
    messages=[
        {
            "role": "user",
            "content": f"""Проанализируй этот PDF документ и дай краткое описание на русском языке.

Включи в описание:
- Тип документа
- Основную тему/содержание
- Ключевые пункты
- Количество страниц (если видно из текста)

Текст документа:
{pdf_text}"""
        }
    ],
    max_tokens=500,
)
analysis = response.choices[0].message.content
```

**Примечания:**
1. Для анализа PDF **не используется системный промпт**. Используется только user prompt с инструкциями.
2. В текущей версии проекта функция `analyze_pdf` определена, но **не используется** в основном коде. Вместо этого текст из PDF извлекается напрямую через `extract_pdf_text` без анализа через AI.

---

## 7. Подготовка контента сообщений для AI

### 7.1. Подготовка полного контента сообщения
**Файл:** `app/application/services/content_service.py`  
**Строки:** 512-683  
**Функция:** `async def prepare_message_content(bot: Bot, message: types.Message, openai_client)`  
**Описание:** Подготавливает полный контент сообщения для обработки AI, включая:
- Текст сообщения/подпись
- Описание изображений (через Vision API)
- Текст из PDF документов
- Текст из документов (txt, docx, xlsx, pptx, odt)
- Транскрипция голосовых сообщений и аудио (через Whisper API)

**Внутренние вызовы AI:**
- Строка 559: `get_image_description(image_url, openai_client)` - для фото
- Строка 628: `transcribe_audio(bot, message, openai_client)` - для голосовых сообщений
- Строка 646: `transcribe_audio(bot, message, openai_client)` - для аудио файлов

**Использование:**
- **Файл:** `app/presentation/routers/channel_router.py`
  - **Строка 174:** Подготовка контента поста для генерации первого комментария
  - **Строка 278:** Подготовка контента поста при обработке автопостов
  - **Строка 458:** Подготовка контента для проверки blacklist медиа-контента
  - **Строка 648:** Подготовка контента комментария пользователя для генерации ответа
  - **Строка 688:** Подготовка контента оригинального поста для контекста

---

## 8. Подготовка истории комментариев

### 8.1. Подготовка истории обсуждения поста
**Файл:** `app/application/services/comment_service.py`  
**Строки:** 187-284  
**Метод:** `async def prepare_conversation_history(...)`  
**Описание:** Подготавливает полную историю комментариев к посту для отправки в ИИ. Формирует структурированный текст с историей обсуждения, который затем передается в `generate_reply_to_comment` как `conversation_history`.

**Примечание:** Эта функция **не делает прямых запросов к AI**, но подготавливает данные, которые будут отправлены в AI при генерации ответа.

**Использование:**
- **Файл:** `app/presentation/routers/channel_router.py`  
- **Строки:** 746-748 (в `discussion_message_handler`)
- **Код:**
```python
conversation_history = await comment_service.prepare_conversation_history(
    session, post_message_id, original_post_content
)
```

---

## Итоговая статистика

### Всего обращений к OpenAI API:

1. **Chat Completions API** (для генерации текста):
   - Генерация комментариев к постам: 1 место (`comment_service.py:162`)
   - Генерация ответов на комментарии: 1 место (`comment_service.py:318`)
   - Описание изображений (Vision): 1 место (`content_service.py:125`)
   - Анализ PDF (не используется): 1 место (`content_service.py:398`)

2. **Whisper API** (для транскрипции аудио):
   - Транскрипция аудио: 2 места (`content_service.py:491, 499`)

### Файлы, содержащие обращения к AI:

1. `app/infrastructure/ai_clients.py` - инициализация клиентов
2. `app/application/services/comment_service.py` - генерация комментариев и ответов
3. `app/application/services/content_service.py` - обработка медиа-контента
4. `app/presentation/routers/channel_router.py` - использование AI сервисов
5. `app/main.py` - инициализация при запуске

---

## Примечания

1. Все запросы к OpenAI выполняются через ProxyAPI (`https://api.proxyapi.ru/openai/v1`)
2. Используется модель `gpt-4o-mini` для всех текстовых запросов
3. Используется модель `whisper-1` для транскрипции аудио
4. Все синхронные вызовы OpenAI обернуты в `asyncio.to_thread` для неблокирующего выполнения
5. Все запросы имеют таймауты для предотвращения зависаний
6. Gemini клиент инициализируется, но не используется в текущей версии проекта

## Системные промпты - сводка

**Где используются системные промпты:**
- ✅ **Генерация комментариев к постам** - используется `COMMENT_SYSTEM_PROMPT` (раздел 2.1)
- ✅ **Генерация ответов на комментарии** - используется `REPLY_SYSTEM_PROMPT` (раздел 3.1)

**Где НЕ используются системные промпты:**
- ❌ **Vision API (описание изображений)** - используется только user prompt
- ❌ **Whisper API (транскрипция аудио)** - системные промпты не поддерживаются
- ❌ **Анализ PDF** - используется только user prompt (функция не используется в продакшене)

**Расположение системных промптов в коде:**
- `COMMENT_SYSTEM_PROMPT` - определен в `app/application/services/comment_service.py`, строки 19-57
- `REPLY_SYSTEM_PROMPT` - определен в `app/application/services/comment_service.py`, строки 60-123

---

## Упоминания канала "Безопасность всегда" в коде

Ниже перечислены все места в коде, где упоминается название канала "Безопасность всегда" и его девиз "Безопасность — это не случайность, а система."

### Документация (README и MD файлы)

1. **`README.md` (строка 1)** - Заголовок документа
   - **Тип:** Название канала
   - **Контекст:** Заголовок проекта
   - **Код:** `# Telegram Bot для канала "Безопасность всегда"`

2. **`README.md` (строка 7)** - Описание проекта
   - **Тип:** Название канала + девиз
   - **Контекст:** Основное описание проекта
   - **Код:** `Бот разработан для канала **"Безопасность всегда"** с девизом: *"Безопасность — это не случайность, а система."*`

3. **`README.md` (строка 396)** - Заключение
   - **Тип:** Название канала
   - **Контекст:** Заключительная часть документа
   - **Код:** `Этот проект разработан для канала "Безопасность всегда".`

4. **`AI_DATA_COLLECTION.md` (строка 83)** - Документация
   - **Тип:** Название канала
   - **Контекст:** Описание данных, отправляемых в ИИ
   - **Код:** `"- Информацию о канале ("Безопасность всегда")"`

5. **`GITHUB_COMMIT_COMMANDS.md` (строка 47)** - Пример коммит-сообщения
   - **Тип:** Название канала
   - **Контекст:** Пример команды git commit
   - **Код:** `git commit -m "Update: Telegram bot for 'Безопасность всегда' channel"`

6. **`AI_API_CALLS.md` (строки 75, 151)** - Документация системных промптов
   - **Тип:** Название канала
   - **Контекст:** Документация системных промптов (этот документ)
   - **Описание:** Упоминания в тексте системных промптов

### Код Python (критически важные упоминания)

7. **`app/application/services/comment_service.py` (строка 20)** - Системный промпт для комментариев
   - **Тип:** Название канала
   - **Контекст:** `COMMENT_SYSTEM_PROMPT` - передается в ИИ при генерации комментариев к постам
   - **Код:** `"Вы бот-администратор в телеграм-канале 'Безопасность всегда'..."`
   - **⚠️ КРИТИЧЕСКИ ВАЖНО:** Это системный промпт, который определяет поведение бота

8. **`app/application/services/comment_service.py` (строка 21)** - Системный промпт для комментариев
   - **Тип:** Девиз канала
   - **Контекст:** `COMMENT_SYSTEM_PROMPT` - передается в ИИ при генерации комментариев к постам
   - **Код:** `"Канал посвящен безопасности: 'Безопасность — это не случайность, а система.'..."`
   - **⚠️ КРИТИЧЕСКИ ВАЖНО:** Это системный промпт, который определяет поведение бота

9. **`app/application/services/comment_service.py` (строка 61)** - Системный промпт для ответов
   - **Тип:** Название канала
   - **Контекст:** `REPLY_SYSTEM_PROMPT` - передается в ИИ при генерации ответов на комментарии
   - **Код:** `"Вы бот-администратор в телеграм-канале 'Безопасность всегда'..."`
   - **⚠️ КРИТИЧЕСКИ ВАЖНО:** Это системный промпт, который определяет поведение бота

10. **`app/application/services/comment_service.py` (строка 62)** - Системный промпт для ответов
    - **Тип:** Девиз канала
    - **Контекст:** `REPLY_SYSTEM_PROMPT` - передается в ИИ при генерации ответов на комментарии
    - **Код:** `"Канал посвящен безопасности: 'Безопасность — это не случайность, а система.'..."`
    - **⚠️ КРИТИЧЕСКИ ВАЖНО:** Это системный промпт, который определяет поведение бота

### Статистика упоминаний:

- **Всего упоминаний:** 10
- **В коде Python:** 4 (пункты 7-10)
- **В документации:** 6 (пункты 1-6)
- **Название канала:** 8 упоминаний (пункты 1, 2, 3, 4, 5, 6, 7, 9)
- **Девиз канала:** 2 упоминания (пункты 2, 8, 10)

### Важные замечания:

1. **Системные промпты (пункты 7-10)** - это **критически важные** упоминания, так как они передаются в ИИ и определяют поведение бота. Любые изменения в этих промптах напрямую влияют на то, как бот генерирует комментарии и ответы.

2. **Формирование истории комментариев** - ранее название канала использовалось в тексте функции `prepare_conversation_history()` (строки 197, 222), который отправляется в ИИ, но было удалено для универсальности кода. Теперь используется общая формулировка "В телеграм канале был опубликован пост".

3. **Документация (пункты 1-6)** - упоминания в README.md и других MD-файлах служат для описания проекта и не влияют на работу бота.

4. **Все упоминания в коде Python** находятся в файле `app/application/services/comment_service.py`, который отвечает за генерацию комментариев через AI. Это центральный файл для работы с ИИ.
