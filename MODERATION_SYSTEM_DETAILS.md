# –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –º–æ–¥–µ—Ä–∞—Ü–∏–∏

## üìã –û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–°–∏—Å—Ç–µ–º–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤, —Ä–∞–±–æ—Ç–∞—é—â–∏—Ö –≤–º–µ—Å—Ç–µ:

1. **–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞** - `channel_router.py` ‚Üí `discussion_message_handler()`
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ blacklist** - `moderation_service.py` ‚Üí `check_message_for_blacklist()`
3. **–í—ã–¥–∞—á–∞ –≤–∞—Ä–Ω–æ–≤** - `user_service.py` ‚Üí `add_warn()`
4. **–£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π** - —á–µ—Ä–µ–∑ aiogram API
5. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±–∞–Ω** - –ø—Ä–∏ 3+ –≤–∞—Ä–Ω–∞—Ö
6. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** - —Ö—Ä–∞–Ω–µ–Ω–∏–µ blacklist, –≤–∞—Ä–Ω–æ–≤, –±–∞–Ω–æ–≤, –ª–æ–≥–æ–≤

---

## üîÑ –ü–æ–ª–Ω—ã–π –ø–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è

### –®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
**–§–∞–π–ª:** `app/presentation/routers/channel_router.py`  
**–§—É–Ω–∫—Ü–∏—è:** `discussion_message_handler()` (—Å—Ç—Ä–æ–∫–∞ 232)

```python
@channel_router.message()
async def discussion_message_handler(message: types.Message, bot: Bot):
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- –ë–æ—Ç –ø–æ–ª—É—á–∞–µ—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ —á–∞—Ç–∞-–æ–±—Å—É–∂–¥–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞
- –ü—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è –∫–æ–º–∞–Ω–¥—ã (–Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å `/`)
- –ü—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∫–∞–Ω–∞–ª–æ–≤ (–∞–≤—Ç–æ–ø–æ—Å—Ç—ã)

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –±–∞–Ω
**–°—Ç—Ä–æ–∫–∏ 273-283**

```python
# –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–∞–Ω–µ–Ω?
if message.from_user:
    user_ban = await get_user_ban(message.from_user.id)
    if user_ban:
        await message.delete()
        await message.answer("‚ùå –í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ. –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã...")
        return  # –ü—Ä–µ—Ä—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–∫—Ç–∏–≤–Ω—ã–π –±–∞–Ω
- –ï—Å–ª–∏ –µ—Å—Ç—å - —Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª—è–µ—Ç—Å—è —Å—Ä–∞–∑—É, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–µ–∫—Ä–∞—â–∞–µ—Ç—Å—è

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ blacklist
**–°—Ç—Ä–æ–∫–∏ 285-414**

```python
# –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: Blacklist (–ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—Å—Ç –∏ –ø–æ–¥–ø–∏—Å—å –∫ –º–µ–¥–∏–∞)
message_text = (message.text or "") + " " + (message.caption or "")
if await check_message_for_blacklist(message_text.strip()):
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞—Ä—É—à–µ–Ω–∏—è...
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- –û–±—ä–µ–¥–∏–Ω—è–µ—Ç—Å—è —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –ø–æ–¥–ø–∏—Å—å –∫ –º–µ–¥–∏–∞
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `check_message_for_blacklist()` –∏–∑ `moderation_service.py`

---

## üîç –î–µ—Ç–∞–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ blacklist

### –§–∞–π–ª: `app/application/services/moderation_service.py`
### –§—É–Ω–∫—Ü–∏—è: `check_message_for_blacklist(text: str) -> bool` (—Å—Ç—Ä–æ–∫–∞ 136)

### –≠—Ç–∞–ø 1: –ü—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã (—Ö–∞—Ä–¥–∫–æ–¥)

**–†—É—Å—Å–∫–∏–µ –º–∞—Ç–µ—Ä–Ω—ã–µ —Å–ª–æ–≤–∞** (—Å—Ç—Ä–æ–∫–∏ 14-39):
```python
RUSSIAN_PROFANITY_PATTERNS = {
    "–∏–¥–∏–æ—Ç": re.compile(r'[–∏i1l][–¥d][–∏i1l][–æo0][—Çt]', re.IGNORECASE),
    "–¥—É—Ä–∞–∫": re.compile(r'[–¥d][—Éy][—Är][–∞a@][–∫k]', re.IGNORECASE),
    # ... –∏ —Ç.–¥.
}
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –æ–±—Ö–æ–¥–∞ –∑–∞–º–µ–Ω –±—É–∫–≤
- –ù–∞–ø—Ä–∏–º–µ—Ä: `[–∏i1l]` - –ª–æ–≤–∏—Ç "–∏", "i", "1", "l"
- `[–∞a@]` - –ª–æ–≤–∏—Ç "–∞", "a", "@"
- –†–µ–≥–∏—Å—Ç—Ä –Ω–µ –≤–∞–∂–µ–Ω (`re.IGNORECASE`)

**–ê–Ω–≥–ª–∏–π—Å–∫–∏–µ –º–∞—Ç–µ—Ä–Ω—ã–µ —Å–ª–æ–≤–∞** (—Å—Ç—Ä–æ–∫–∏ 43-73):
```python
ENGLISH_PROFANITY_PATTERNS = {
    "fuck": re.compile(r'f+u+c+k+', re.IGNORECASE),
    # ... –∏ —Ç.–¥.
}
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- `f+` –æ–∑–Ω–∞—á–∞–µ—Ç –æ–¥–Ω—É –∏–ª–∏ –±–æ–ª–µ–µ –±—É–∫–≤ "f" (–ª–æ–≤–∏—Ç "f", "ff", "fff")
- –£—á–∏—Ç—ã–≤–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–≤—Ç–æ—Ä—ã –±—É–∫–≤

**–ü—Ä–æ–≤–µ—Ä–∫–∞** (—Å—Ç—Ä–æ–∫–∏ 150-161):
```python
# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä—É—Å—Å–∫–∏–µ –º–∞—Ç–µ—Ä–Ω—ã–µ —Å–ª–æ–≤–∞
for word, pattern in RUSSIAN_PROFANITY_PATTERNS.items():
    if pattern.search(text):
        logger.warning(f"‚ö†Ô∏è –ù–ê–ô–î–ï–ù–û –ù–ê–†–£–®–ï–ù–ò–ï! –†—É—Å—Å–∫–æ–µ –º–∞—Ç–µ—Ä–Ω–æ–µ —Å–ª–æ–≤–æ '{word}'...")
        return True  # –ù–∞—Ä—É—à–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ!

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –º–∞—Ç–µ—Ä–Ω—ã–µ —Å–ª–æ–≤–∞
for word, pattern in ENGLISH_PROFANITY_PATTERNS.items():
    if pattern.search(text):
        logger.warning(f"‚ö†Ô∏è –ù–ê–ô–î–ï–ù–û –ù–ê–†–£–®–ï–ù–ò–ï! –ê–Ω–≥–ª–∏–π—Å–∫–æ–µ –º–∞—Ç–µ—Ä–Ω–æ–µ —Å–ª–æ–≤–æ '{word}'...")
        return True  # –ù–∞—Ä—É—à–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ!
```

### –≠—Ç–∞–ø 2: –§—Ä–∞–∑—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (—Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º)

**–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ blacklist** (—Å—Ç—Ä–æ–∫–∏ 20-60):
```python
# –ö—ç—à –¥–ª—è blacklist –∏–∑ –ë–î
_blacklist_cache: Optional[List] = None
_cache_timestamp: Optional[datetime] = None
_cache_ttl: timedelta = timedelta(minutes=5)  # –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫—ç—à–∞ (5 –º–∏–Ω—É—Ç)

async def _get_cached_blacklist() -> List:
    """
    –ü–æ–ª—É—á–∞–µ—Ç blacklist –∏–∑ –∫—ç—à–∞ –∏–ª–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏–∑ –ë–î, –µ—Å–ª–∏ –∫—ç—à —É—Å—Ç–∞—Ä–µ–ª.
    """
    global _blacklist_cache, _cache_timestamp
    
    now = datetime.utcnow()
    
    if _blacklist_cache is None or _cache_timestamp is None or (now - _cache_timestamp) > _cache_ttl:
        logger.debug("üîÑ –ö—ç—à blacklist —É—Å—Ç–∞—Ä–µ–ª –∏–ª–∏ –ø—É—Å—Ç, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ –ë–î...")
        _blacklist_cache = await _load_blacklist_from_db()
        _cache_timestamp = now
        logger.info(f"‚úÖ Blacklist –∑–∞–≥—Ä—É–∂–µ–Ω –≤ –∫—ç—à: {len(_blacklist_cache)} —Ñ—Ä–∞–∑")
    
    return _blacklist_cache
```

**–ü–æ–ª—É—á–µ–Ω–∏–µ blacklist –∏–∑ –∫—ç—à–∞** (—Å—Ç—Ä–æ–∫–∏ 164-165):
```python
# –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î
blacklist = await _get_cached_blacklist()
```

**–ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞** (–ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏/—É–¥–∞–ª–µ–Ω–∏–∏ —Ñ—Ä–∞–∑):
```python
def invalidate_blacklist_cache():
    """
    –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∫—ç—à blacklist (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏—Ç –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—Ä–æ—Å–µ).
    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏/—É–¥–∞–ª–µ–Ω–∏–∏ —Ñ—Ä–∞–∑ –∏–∑ blacklist.
    """
    global _blacklist_cache, _cache_timestamp
    _blacklist_cache = None
    _cache_timestamp = None
    logger.debug("üîÑ –ö—ç—à blacklist –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω")
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è:**
- ‚úÖ –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –£—Å–∫–æ—Ä–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
- ‚úÖ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ blacklist

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥–æ–π —Ñ—Ä–∞–∑—ã** (—Å—Ç—Ä–æ–∫–∏ 168-191):
```python
for item in blacklist:
    phrase = item.phrase.strip()
    
    # –ú–µ—Ç–æ–¥ 1: –ü—Ä–æ—Å—Ç–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ (–±—ã—Å—Ç—Ä–æ)
    if phrase_lower in text_lower:
        return True  # –ù–∞—Ä—É—à–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ!
    
    # –ú–µ—Ç–æ–¥ 2: –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ (—É–º–Ω–µ–µ, –ª–æ–≤–∏—Ç –∑–∞–º–µ–Ω—ã –±—É–∫–≤)
    regex_pattern = create_regex_from_phrase(phrase)
    if regex_pattern.search(text):
        return True  # –ù–∞—Ä—É—à–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ!
```

**–§—É–Ω–∫—Ü–∏—è `create_regex_from_phrase()`** (—Å—Ç—Ä–æ–∫–∏ 76-134):
- –°–æ–∑–¥–∞–µ—Ç —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ —Ñ—Ä–∞–∑—ã
- –£—á–∏—Ç—ã–≤–∞–µ—Ç –∑–∞–º–µ–Ω—ã –±—É–∫–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä: `–∞` ‚Üí `[–∞a@4]`)
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–æ–±–µ–ª—ã –∏ –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è

**–ú–∞–ø–ø–∏–Ω–≥ –±—É–∫–≤** (—Å—Ç—Ä–æ–∫–∏ 84-119):
```python
char_map = {
    '–∞': '[–∞a@4]',  # –õ–æ–≤–∏—Ç —Ä—É—Å—Å–∫—É—é "–∞", –∞–Ω–≥–ª–∏–π—Å–∫—É—é "a", "@", "4"
    '–æ': '[–æo0]',   # –õ–æ–≤–∏—Ç —Ä—É—Å—Å–∫—É—é "–æ", –∞–Ω–≥–ª–∏–π—Å–∫—É—é "o", "0"
    '–∏': '[–∏i1l]', # –õ–æ–≤–∏—Ç —Ä—É—Å—Å–∫—É—é "–∏", –∞–Ω–≥–ª–∏–π—Å–∫—É—é "i", "1", "l"
    # ... –∏ —Ç.–¥.
}
```

---

## ‚ö†Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞—Ä—É—à–µ–Ω–∏—è blacklist

### –§–∞–π–ª: `app/presentation/routers/channel_router.py`
### –§—É–Ω–∫—Ü–∏—è: `discussion_message_handler()` (—Å—Ç—Ä–æ–∫–∏ 285-414)

### –®–∞–≥ 1: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å—Ç—Ä–æ–∫–∏ 302-311)

```python
# –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
await register_user(
    message.from_user.id,
    username=message.from_user.username,
    full_name=message.from_user.full_name
)
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –≤ –ë–î - —Å–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å
- –ï—Å–ª–∏ –µ—Å—Ç—å - –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (username, full_name)

### –®–∞–≥ 2: –í—ã–¥–∞—á–∞ –≤–∞—Ä–Ω–∞ (—Å—Ç—Ä–æ–∫–∏ 313-328)

```python
# –í—ã–¥–∞–µ–º –≤–∞—Ä–Ω –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ blacklist
await add_warn(
    message.from_user.id,
    reason="–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã—Ö —Å–ª–æ–≤/–≤—ã—Ä–∞–∂–µ–Ω–∏–π (blacklist)",
    admin_id=None  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤–∞—Ä–Ω
)
# –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞—Ä–Ω–æ–≤
warn_count = await get_user_warns_count(message.from_user.id)
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–Ω—É—Ç—Ä–∏ `add_warn()`** (`user_service.py`, —Å—Ç—Ä–æ–∫–∏ 56-79):

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
   ```python
   user = await UserRepository.get_by_id(session, user_id)
   if not user:
       # –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
       user = User(id=user_id, status=UserStatus.ACTIVE)
       user = await UserRepository.add(session, user)
   ```

2. **–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ Warn:**
   ```python
   warn = Warn(user_id=user_id, reason=reason)
   warn = await WarnRepository.add(session, warn)
   ```

3. **–£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –≤–∞—Ä–Ω–æ–≤:**
   ```python
   await UserRepository.increment_warn_count(session, user_id)
   # user.warn_count —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ 1
   ```

4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   ```python
   await LogRepository.add(session, Log(
       event_type="warn_added",
       user_id=admin_id,
       message=f"–í–∞—Ä–Ω –¥–æ–±–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}. –ü—Ä–∏—á–∏–Ω–∞: {reason}"
   ))
   ```

### –®–∞–≥ 3: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (—Å—Ç—Ä–æ–∫–∏ 338-345)

```python
warning_msg = (
    f"{username}, ‚ö†Ô∏è –í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ –∏–∑-–∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã—Ö —Å–ª–æ–≤/–≤—ã—Ä–∞–∂–µ–Ω–∏–π.\n"
    f"–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π: {warn_count}/3\n"
    f"–ü–æ—Å–ª–µ —Ç—Ä–µ—Ö –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –í–∞–º –∑–∞–ø—Ä–µ—Ç—è—Ç –Ω–∞ 24 —á–∞—Å–∞ –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç—ã."
)
```

**–§–æ—Ä–º–∞—Ç:**
- –û–±—Ä–∞—â–µ–Ω–∏–µ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (username –∏–ª–∏ ID)
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
- –¢–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞—Ä–Ω–æ–≤ (X/3)
- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –±–∞–Ω–µ –ø—Ä–∏ 3+ –≤–∞—Ä–Ω–∞—Ö

### –®–∞–≥ 4: –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (—Å—Ç—Ä–æ–∫–∏ 347-363)

```python
# –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –î–û —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
try:
    # –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å reply –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
    sent_notification = await message.reply(warning_msg)
except Exception as reply_error:
    # –ï—Å–ª–∏ reply –Ω–µ —É–¥–∞–ª—Å—è (–Ω–µ—Ç –ø—Ä–∞–≤), –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ —á–∞—Ç –±–µ–∑ reply
    sent_notification = await bot.send_message(
        chat_id=message.chat.id,
        text=warning_msg
    )
```

**–ü–æ—á–µ–º—É –î–û —É–¥–∞–ª–µ–Ω–∏—è:**
- `message.reply()` —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è `message.reply()` –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç

### –®–∞–≥ 5: –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (—Å—Ç—Ä–æ–∫–∏ 365-379)

```python
# –¢–ï–ü–ï–†–¨ —É–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ (–ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)
try:
    await message.delete()
    logger.info(f"‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ {message.message_id} —É–¥–∞–ª–µ–Ω–æ –∏–∑-–∑–∞ blacklist")
except Exception as delete_error:
    logger.error(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {delete_error}")
    # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `message.delete()` –∏–∑ aiogram
- –ï—Å–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å (–Ω–µ—Ç –ø—Ä–∞–≤ –±–æ—Ç–∞) - –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –æ—à–∏–±–∫–∞

### –®–∞–≥ 6: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (—Å—Ç—Ä–æ–∫–∏ 381-393)

```python
await LogRepository.add(session, Log(
    event_type="message_deleted_blacklist",
    user_id=message.from_user.id,
    message=f"–°–æ–æ–±—â–µ–Ω–∏–µ {message.message_id} —É–¥–∞–ª–µ–Ω–æ –∏–∑-–∑–∞ blacklist, –≤—ã–¥–∞–Ω –≤–∞—Ä–Ω ({warn_count}/3)"
))
```

**–ß—Ç–æ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è:**
- –¢–∏–ø —Å–æ–±—ã—Ç–∏—è: `message_deleted_blacklist`
- ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –°–æ–æ–±—â–µ–Ω–∏–µ —Å –¥–µ—Ç–∞–ª—è–º–∏

### –®–∞–≥ 7: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±–∞–Ω –ø—Ä–∏ 3+ –≤–∞—Ä–Ω–∞—Ö (—Å—Ç—Ä–æ–∫–∏ 395-412)

```python
# –ï—Å–ª–∏ 3+ –≤–∞—Ä–Ω–æ–≤ ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±–∞–Ω –Ω–∞ 24 —á–∞—Å–∞
if warn_count >= 3:
    await ban_user(
        message.from_user.id,
        reason="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±–∞–Ω –∑–∞ 3+ –≤–∞—Ä–Ω–æ–≤ (–Ω–∞—Ä—É—à–µ–Ω–∏–µ blacklist)",
        days=1,  # –ë–∞–Ω –Ω–∞ 24 —á–∞—Å–∞ (1 –¥–µ–Ω—å)
        admin_id=None
    )
    await bot.send_message(
        chat_id=message.chat.id,
        text=f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {username_display} –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–±–∞–Ω–µ–Ω –Ω–∞ 24 —á–∞—Å–∞..."
    )
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–Ω—É—Ç—Ä–∏ `ban_user()`** (`user_service.py`, —Å—Ç—Ä–æ–∫–∏ 81-108):

1. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
   ```python
   await UserRepository.update_status(session, user_id, UserStatus.BANNED)
   ```

2. **–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ Ban:**
   ```python
   until = datetime.datetime.utcnow() + datetime.timedelta(days=days)
   ban = Ban(user_id=user_id, reason=reason, until=until)
   ban = await BanRepository.add(session, ban)
   ```

3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   ```python
   await LogRepository.add(session, Log(
       event_type="user_banned",
       user_id=admin_id,
       message=f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –∑–∞–±–∞–Ω–µ–Ω. –ü—Ä–∏—á–∏–Ω–∞: {reason}"
   ))
   ```

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `users`
```python
class User(Base):
    id = Column(Integer, primary_key=True)  # Telegram user_id
    username = Column(String(64))
    full_name = Column(String(128))
    status = Column(SQLEnum(UserStatus))  # ACTIVE, BANNED, RESTRICTED
    warn_count = Column(Integer, default=0)  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞—Ä–Ω–æ–≤
    is_banned = Column(Boolean, default=False)  # –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    created_at = Column(DateTime)
```

**–í–∞–∂–Ω–æ:**
- `warn_count` - —Å—á–µ—Ç—á–∏–∫ –≤–∞—Ä–Ω–æ–≤ (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–æ–≤–æ–º –≤–∞—Ä–Ω–µ)
- `status` - —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –¢–∞–±–ª–∏—Ü–∞ `warns`
```python
class Warn(Base):
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"))
    reason = Column(String(255))  # –ü—Ä–∏—á–∏–Ω–∞ –≤–∞—Ä–Ω–∞
    created_at = Column(DateTime)  # –ö–æ–≥–¥–∞ –≤—ã–¥–∞–Ω
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ö–∞–∂–¥—ã–π –≤–∞—Ä–Ω - –æ—Ç–¥–µ–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å
- –ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –≤–∞—Ä–Ω–æ–≤ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
- –°–≤—è–∑—å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º —á–µ—Ä–µ–∑ `user_id`

### –¢–∞–±–ª–∏—Ü–∞ `blacklist`
```python
class BlacklistItem(Base):
    id = Column(Integer, primary_key=True)
    phrase = Column(String(255), unique=True)  # –ó–∞–ø—Ä–µ—â–µ–Ω–Ω–∞—è —Ñ—Ä–∞–∑–∞
    created_at = Column(DateTime)
    added_by = Column(Integer)  # admin_id –∫—Ç–æ –¥–æ–±–∞–≤–∏–ª
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ö–∞–∂–¥–∞—è —Ñ—Ä–∞–∑–∞ —É–Ω–∏–∫–∞–ª—å–Ω–∞
- –•—Ä–∞–Ω–∏—Ç—Å—è, –∫—Ç–æ –¥–æ–±–∞–≤–∏–ª —Ñ—Ä–∞–∑—É

### –¢–∞–±–ª–∏—Ü–∞ `bans`
```python
class Ban(Base):
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"))
    reason = Column(String(255))  # –ü—Ä–∏—á–∏–Ω–∞ –±–∞–Ω–∞
    until = Column(DateTime, nullable=True)  # –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è (None = –±–µ—Å—Å—Ä–æ—á–Ω—ã–π)
    created_at = Column(DateTime)
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- `until` –º–æ–∂–µ—Ç –±—ã—Ç—å `None` (–±–µ—Å—Å—Ä–æ—á–Ω—ã–π –±–∞–Ω) –∏–ª–∏ –¥–∞—Ç–æ–π (–≤—Ä–µ–º–µ–Ω–Ω—ã–π –±–∞–Ω)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–Ω–∏–º–∞–µ—Ç—Å—è –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ —Å—Ä–æ–∫–∞

### –¢–∞–±–ª–∏—Ü–∞ `logs`
```python
class Log(Base):
    id = Column(Integer, primary_key=True)
    event_type = Column(String(32))  # –¢–∏–ø —Å–æ–±—ã—Ç–∏—è
    user_id = Column(Integer, ForeignKey("users.id"))
    message = Column(Text)  # –î–µ—Ç–∞–ª–∏ —Å–æ–±—ã—Ç–∏—è
    created_at = Column(DateTime)
```

**–¢–∏–ø—ã —Å–æ–±—ã—Ç–∏–π:**
- `warn_added` - –≤—ã–¥–∞–Ω –≤–∞—Ä–Ω
- `user_banned` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–∞–Ω–µ–Ω
- `message_deleted_blacklist` - —Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ –∏–∑-–∑–∞ blacklist
- `blacklist_added` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—Ä–∞–∑–∞ –≤ blacklist

---

## üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ–¥–∏–∞-–∫–æ–Ω—Ç–µ–Ω—Ç–∞

### –§–æ—Ç–æ (—Å—Ç—Ä–æ–∫–∏ 428-459)

```python
if message.photo:
    # –ü–æ–ª—É—á–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ–æ—Ç–æ —á–µ—Ä–µ–∑ AI
    full_content = await prepare_message_content(bot, message, ai_clients.openai)
    
    # –ò—â–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–Ω—Ç–µ
    if "–û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:" in full_content:
        image_description = # ... –∏–∑–≤–ª–µ–∫–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º: —Ç–µ–∫—Å—Ç + –ø–æ–¥–ø–∏—Å—å + –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ–æ—Ç–æ
        image_content_for_check = f"{text_message} {caption} {image_description}"
        
        if await check_and_handle_blacklist_violation(...):
            return  # –°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ
```

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è:**
- –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
- –ü–æ–¥–ø–∏—Å—å –∫ —Ñ–æ—Ç–æ
- –û–ø–∏—Å–∞–Ω–∏–µ —Ñ–æ—Ç–æ (—á–µ—Ä–µ–∑ OpenAI Vision API)

### PDF –¥–æ–∫—É–º–µ–Ω—Ç—ã (—Å—Ç—Ä–æ–∫–∏ 461-494)

```python
if message.document and message.document.file_name.endswith('.pdf'):
    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ PDF
    full_content = await prepare_message_content(...)
    
    if "–¢–µ–∫—Å—Ç –∏–∑ PDF –¥–æ–∫—É–º–µ–Ω—Ç–∞:" in full_content:
        pdf_text_content = # ... –∏–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º: —Ç–µ–∫—Å—Ç + –ø–æ–¥–ø–∏—Å—å + —Ç–µ–∫—Å—Ç –∏–∑ PDF
        pdf_content_for_check = f"{text_message} {caption} {pdf_text_content}"
        
        if await check_and_handle_blacklist_violation(...):
            return  # –°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ
```

### –î—Ä—É–≥–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã (—Å—Ç—Ä–æ–∫–∏ 496-538)

–ü—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –¥–æ–∫—É–º–µ–Ω—Ç—ã: `.txt`, `.docx`, `.xlsx`, `.pptx`, `.odt`

### –ê—É–¥–∏–æ (—Å—Ç—Ä–æ–∫–∏ 540-573)

```python
if message.voice or message.audio:
    # –ü–æ–ª—É—á–∞–µ–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é —á–µ—Ä–µ–∑ OpenAI Whisper
    full_content = await prepare_message_content(...)
    
    if "–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∞—É–¥–∏–æ:" in full_content:
        transcription_content = # ... –∏–∑–≤–ª–µ–∫–∞–µ–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º: —Ç–µ–∫—Å—Ç + –ø–æ–¥–ø–∏—Å—å + —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è
        audio_content_for_check = f"{text_message} {caption} {transcription_content}"
        
        if await check_and_handle_blacklist_violation(...):
            return  # –°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ
```

---

## üéØ –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã

### 1. –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

1. **–•–∞—Ä–¥–∫–æ–¥ –ø–∞—Ç—Ç–µ—Ä–Ω—ã** - –±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –º–∞—Ç–µ—Ä–Ω—ã—Ö —Å–ª–æ–≤
2. **–ë–î blacklist** - –≥–∏–±–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ñ—Ä–∞–∑
3. **–†–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è** - –æ–±—Ö–æ–¥ –∑–∞–º–µ–Ω –±—É–∫–≤

### 2. –ó–∞—â–∏—Ç–∞ –æ—Ç –æ–±—Ö–æ–¥–∞

- –£—á–µ—Ç –∑–∞–º–µ–Ω –±—É–∫–≤: `–∞` ‚Üí `a`, `@`, `4`
- –£—á–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞: `–ò–î–ò–û–¢` = `–∏–¥–∏–æ—Ç` = `–ò–¥–ò–æ–¢`
- –£—á–µ—Ç –ø–æ–≤—Ç–æ—Ä–æ–≤: `fffuck` = `fuck`
- –£—á–µ—Ç –ø—Ä–æ–±–µ–ª–æ–≤: `–∏ –¥ –∏ –æ —Ç` = `–∏–¥–∏–æ—Ç`

### 3. –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤—ã–¥–∞—á–∞ –≤–∞—Ä–Ω–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±–∞–Ω –ø—Ä–∏ 3+ –≤–∞—Ä–Ω–∞—Ö
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

- –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ - –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –æ—à–∏–±–∫–∞
- –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –≤—ã–¥–∞—Ç—å –≤–∞—Ä–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback
- –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ - –ø—Ä–æ–±—É—é—Ç—Å—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã

---

## üìù –ü—Ä–∏–º–µ—Ä –ø–æ–ª–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ "–¢—ã –∏–¥–∏–æ—Ç!"

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è:**
   - `discussion_message_handler()` –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –±–∞–Ω:**
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–±–∞–Ω–µ–Ω ‚Üí –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ blacklist:**
   - `check_message_for_blacklist("–¢—ã –∏–¥–∏–æ—Ç!")`
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ö–∞—Ä–¥–∫–æ–¥ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤:
     - `RUSSIAN_PROFANITY_PATTERNS["–∏–¥–∏–æ—Ç"]` ‚Üí `re.compile(r'[–∏i1l][–¥d][–∏i1l][–æo0][—Çt]')`
     - `pattern.search("–¢—ã –∏–¥–∏–æ—Ç!")` ‚Üí **–ù–ê–ô–î–ï–ù–û!**
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `True`

4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞—Ä—É—à–µ–Ω–∏—è:**
   - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
   - –í—ã–¥–∞—á–∞ –≤–∞—Ä–Ω–∞:
     - –°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ `warns`
     - `user.warn_count` —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –±—ã–ª–æ 1, —Å—Ç–∞–ª–æ 2)
   - –ü–æ–ª—É—á–µ–Ω–∏–µ `warn_count = 2`

5. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:**
   - –§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ: "–ò–≤–∞–Ω, ‚ö†Ô∏è –í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ... –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π: 2/3"
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ `message.reply()`

6. **–£–¥–∞–ª–µ–Ω–∏–µ:**
   - `message.delete()` —É–¥–∞–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ

7. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ `logs`: `event_type="message_deleted_blacklist"`

8. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –±–∞–Ω:**
   - `warn_count = 2` < 3 ‚Üí –±–∞–Ω –Ω–µ –≤—ã–¥–∞–µ—Ç—Å—è

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª –≤–∞—Ä–Ω (2/3)

---

## üîß –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### –ú–æ–¥—É–ª–∏:

1. **`moderation_service.py`** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ blacklist
   - `check_message_for_blacklist()` - –æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏
   - `create_regex_from_phrase()` - —Å–æ–∑–¥–∞–Ω–∏–µ regex –∏–∑ —Ñ—Ä–∞–∑—ã
   - `add_to_blacklist()` / `remove_from_blacklist()` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ blacklist

2. **`user_service.py`** - —Ä–∞–±–æ—Ç–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
   - `add_warn()` - –≤—ã–¥–∞—á–∞ –≤–∞—Ä–Ω–∞
   - `ban_user()` - –≤—ã–¥–∞—á–∞ –±–∞–Ω–∞
   - `get_user_warns_count()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤–∞—Ä–Ω–æ–≤

3. **`channel_router.py`** - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
   - `discussion_message_handler()` - –≥–ª–∞–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
   - `check_and_handle_blacklist_violation()` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞—Ä—É—à–µ–Ω–∏—è

4. **`repositories.py`** - —Ä–∞–±–æ—Ç–∞ —Å –ë–î
   - `BlacklistRepository` - —Ä–∞–±–æ—Ç–∞ —Å blacklist
   - `WarnRepository` - —Ä–∞–±–æ—Ç–∞ —Å –≤–∞—Ä–Ω–∞–º–∏
   - `UserRepository` - —Ä–∞–±–æ—Ç–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

---

## üí° –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### ‚úÖ 1. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ blacklist (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)
- Blacklist –∫—ç—à–∏—Ä—É–µ—Ç—Å—è –Ω–∞ 5 –º–∏–Ω—É—Ç
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
- –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ë–î
- –£—Å–∫–æ—Ä–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

### ‚úÖ 2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)
- –£—Å—Ç—Ä–∞–Ω–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–∑–æ–≤–∞ `prepare_message_content`
- –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –º–µ–¥–∏–∞-–∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
- –°–Ω–∏–∂–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ API-–≤—ã–∑–æ–≤–æ–≤ –∫ OpenAI

### ‚úÖ 3. –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)
- –í—Å–µ –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—ã–π –º–æ–¥—É–ª—å `error_handler`
- –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—à–∏–±–æ–∫ –ø–æ —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏ (LOW, MEDIUM, HIGH, CRITICAL)
- –ö–æ–Ω—Ç–µ–∫—Å—Ç –æ—à–∏–±–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫

### ‚úÖ 4. –£–ª—É—á—à–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)
- –ó–∞–º–µ–Ω–µ–Ω—ã –≤—Å–µ `print()` –Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ï–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ª–æ–≥–æ–≤ —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –º–µ—Ç–∫–∞–º–∏
- –£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è: DEBUG, INFO, WARNING, ERROR, CRITICAL
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ—Ä–µ–∑ –º–æ–¥—É–ª—å `logger`

## üí° –í–æ–∑–º–æ–∂–Ω—ã–µ –¥–∞–ª—å–Ω–µ–π—à–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞** - –ø—Ä–æ–≤–µ—Ä—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
2. **–ú–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ** - –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞—Ä—É—à–µ–Ω–∏–π
3. **–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑** - —É—á–∏—Ç—ã–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
4. **Whitelist** - –∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π/—Ñ—Ä–∞–∑

---

**–°–∏—Å—Ç–µ–º–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ —É–ª—É—á—à–∞–µ—Ç—Å—è!** üöÄ
