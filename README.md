# AdminBot - Telegram Bot Administrator

Telegram-бот администратор для канала с поддержкой автоматической модерации, варнов, банов и черного списка. Бот автоматически модерирует комментарии в канале, удаляет запрещенный контент, выдает предупреждения и банит нарушителей.

## Архитектура

Проект использует Clean Architecture с разделением на слои:
- **Presentation** - обработка Telegram API (aiogram)
- **Application** - бизнес-логика и сервисы
- **Infrastructure** - БД (SQLAlchemy), внешние сервисы
- **Domain** - доменные модели

## Установка

1. Клонируйте репозиторий:
```bash
git clone <repository_url>
cd tgu
```

2. Создайте виртуальное окружение:
```bash
python -m venv venv
source venv/bin/activate  # Linux/Mac
# или
venv\Scripts\activate  # Windows
```

3. Установите зависимости:
```bash
pip install -r requirements.txt
```

4. Создайте файл `.env` в корне проекта:
```env
BOT_TOKEN=your_telegram_bot_token
ADMIN_IDS=123456789,987654321
DB_URL=sqlite+aiosqlite:///app.db
```

5. Инициализируйте базу данных:
```bash
python -m app.scripts.init_db
```

6. (Опционально) Загрузите предварительный черный список:
```bash
python -m app.scripts.init_default_blacklist
```

## Запуск

```bash
python -m app.main
```

## Функциональность

### Пользовательские команды

- `/start` - регистрация в системе или обновление информации о пользователе
- `/help` - справка по доступным командам (для всех пользователей, админы видят дополнительные команды)

### Админ-команды

Доступны только пользователям, указанным в `ADMIN_IDS`:

- `/ban {user_id} {reason}` - заблокировать пользователя на указанный срок или навсегда
- `/warn {user_id} {reason}` - выдать предупреждение пользователю
- `/blacklist add {phrase}` - добавить фразу в черный список
- `/blacklist remove {phrase}` - удалить фразу из черного списка
- `/blacklist list [page]` - показать черный список постранично (10 фраз на страницу)
- `/stats` - статистика бота (пользователи, баны, варны, логи)

### Автоматическая модерация

- **Проверка черного списка**: автоматическая проверка всех сообщений на наличие запрещенных фраз (поддержка многоязычного blacklist с регулярными выражениями)
- **Удаление сообщений**: автоматическое удаление сообщений с запрещенным контентом
- **Уведомления пользователей**: при удалении сообщения пользователь получает уведомление с указанием username, количества предупреждений и информации о 24-часовом бане
- **Система предупреждений**: автоматический варн при нарушении blacklist
- **Автоматический бан**: при накоплении 3+ предупреждений пользователь автоматически получает бан на 24 часа
- **Автоматическое снятие банов**: фоновая задача каждые 5 минут проверяет и автоматически снимает истекшие баны
- **Проверка банов**: забаненные пользователи не могут отправлять сообщения - они автоматически удаляются

### Обработка ошибок

- Обработка сетевых ошибок с повторными попытками при отправке сообщений
- Логирование всех действий для отладки и аудита
- Graceful handling ошибок без падения бота

### Модели данных

- **User** - пользователи бота (id, username, full_name, status, warn_count)
- **Ban** - записи о банах (user_id, reason, until - время окончания бана, NULL = навсегда)
- **Warn** - записи о предупреждениях (user_id, reason, created_at)
- **BlacklistItem** - фразы черного списка (phrase)
- **Log** - логи действий (event_type, user_id, message, timestamp)

### Система предупреждений и банов

- Первое нарушение: предупреждение + удаление сообщения
- Второе нарушение: предупреждение (2/3) + удаление сообщения
- Третье нарушение: предупреждение (3/3) + автоматический бан на 24 часа
- После 24 часов: автоматическое снятие бана, счетчик предупреждений сохраняется

## Структура проекта

```
app/
├── main.py                    # Точка входа, инициализация БД, запуск polling
├── config/
│   └── settings.py           # Настройки приложения (pydantic-settings)
├── presentation/
│   ├── routers/              # Роутеры aiogram
│   │   ├── user_router.py    # Публичные команды (/start, /help)
│   │   ├── admin_router.py   # Админ-команды (/ban, /warn, /blacklist, /stats)
│   │   └── channel_router.py # Обработка канала и автоматическая модерация
│   └── middlewares/          # Middleware
│       └── admin_mw.py       # Проверка прав администратора
├── application/
│   └── services/             # Бизнес-логика
│       ├── user_service.py   # Управление пользователями (регистрация, баны, варны, авторазбан)
│       ├── moderation_service.py  # Модерация (проверка blacklist с regex)
│       └── stats_service.py  # Статистика бота
├── infrastructure/
│   └── db/
│       ├── models.py         # SQLAlchemy ORM модели
│       ├── session.py        # Настройка сессий и миграции БД
│       └── repositories.py   # Репозитории (Repository pattern)
└── scripts/
    ├── init_db.py            # Инициализация БД и создание таблиц
    ├── init_default_blacklist.py  # Предварительный многоязычный blacklist
    ├── add_words_to_blacklist.py  # Добавление слов в blacklist
    └── clear_warns_bans.py   # Очистка варнов и банов из БД
```

## Особенности реализации

### Обработка роутеров

Роутеры регистрируются в определенном порядке для корректной обработки команд:
1. `admin_router` - обрабатывает админ-команды
2. `user_router` - обрабатывает публичные команды (/start, /help)
3. `channel_router` - обрабатывает обычные сообщения (команды пропускаются)

### Фоновые задачи

- Автоматическая проверка истекших банов каждые 5 минут
- Graceful shutdown с корректной остановкой фоновых задач

### База данных

- SQLite для разработки (легко переключиться на PostgreSQL)
- Автоматические миграции при добавлении новых колонок
- Асинхронная работа через SQLAlchemy 2.0 + aiosqlite

## Формат сообщений

### Уведомление при удалении сообщения

При удалении сообщения с запрещенным контентом пользователь получает:

```
@username, ⚠️ Ваше сообщение удалено из-за использования запрещенных слов/выражений.
Предупреждений: 2/3
После трех предупреждений Вам запретят на 24 часа комментировать посты.
```

### Автоматический бан

При накоплении 3+ предупреждений:
- Пользователь автоматически получает бан на 24 часа
- Через 24 часа бан автоматически снимается
- Счетчик предупреждений сохраняется

## Утилиты

### Инициализация черного списка

Загрузка предварительного многоязычного blacklist (русский, украинский, белорусский, казахский, английский, немецкий, французский):

```bash
python -m app.scripts.init_default_blacklist
```

### Добавление слов в blacklist

```bash
python app/scripts/add_words_to_blacklist.py
```

### Очистка варнов и банов

```bash
python app/scripts/clear_warns_bans.py
```

## Технический стек

- **Python 3.10+**
- **aiogram 3.4.1** - фреймворк для Telegram Bot API
- **SQLAlchemy 2.0** - ORM для работы с БД
- **aiosqlite** - асинхронный драйвер для SQLite
- **pydantic-settings** - управление настройками
- **python-dotenv** - загрузка переменных окружения

## Лицензия

MIT
