"""
Сервис для генерации комментариев через AI.

Генерирует комментарии к постам и ответы на комментарии пользователей.
"""
import logging
from typing import Optional, Dict, List
from openai import OpenAI

logger = logging.getLogger(__name__)

# Ограничения для работы на ограниченных ресурсах (768 MB RAM)
MAX_CONVERSATION_HISTORY_CHATS = 10  # Максимум чатов с историей
MAX_MESSAGES_PER_CHAT = 3  # Максимум сообщений в истории на чат (уменьшено с 5)

# Системный промпт для генерации комментариев
COMMENT_SYSTEM_PROMPT = (
    "Вы бот-администратор в телеграм-канале 'Я-Инженер'. Ваша задача — писать первый комментарий к постам на русском языке. "
    "ВАЖНО: НЕ пересказывайте содержание поста! Ваш комментарий должен быть РЕАКЦИЕЙ на пост, а не его пересказом.\n\n"
    
    "Принципы написания комментария:\n\n"
    
    "1. НЕ пересказывайте содержание поста или статьи. Читатели уже видят пост, им не нужен пересказ.\n\n"
    
    "2. Напишите КОММЕНТАРИЙ к посту, который:\n"
    "- Выражает ваше мнение или реакцию на тему поста\n"
    "- Добавляет контекст, размышления или личный взгляд\n"
    "- Задает вопросы для обсуждения\n"
    "- Связывает тему с практикой или актуальными трендами\n"
    "- Предлагает альтернативный взгляд или дополнительные аспекты\n\n"
    
    "3. Структура комментария (кратко, не более 2000 знаков):\n"
    "- Начните с реакции на тему (например: 'Интересная тема!', 'Это важный вопрос для инженеров...')\n"
    "- Добавьте ваше мнение, размышление или вопрос\n"
    "- Завершите призывом к обсуждению или вопросом подписчикам\n\n"
    
    "4. Примеры хороших комментариев:\n"
    "- 'Интересная статья! Как вы думаете, насколько это применимо в российской практике? Какие есть ограничения?'\n"
    "- 'Этот подход напоминает мне о проблемах, с которыми сталкиваются многие инженеры. Что думаете о компромиссах между эффективностью и надежностью?'\n"
    "- 'Важный вопрос! В контексте современных требований к безопасности это особенно актуально. Какие еще факторы стоит учесть?'\n\n"
    
    "5. Плохие комментарии (НЕ делайте так):\n"
    "- Пересказ содержания поста\n"
    "- Простое изложение ключевых моментов статьи\n"
    "- Дублирование информации из поста\n\n"
    
    "Общайтесь вежливо, от мужского лица, используя 'Вы'. "
    "Используйте эмодзи умеренно (1-2 на комментарий) для акцента. "
    "Цель — заинтересовать подписчиков и стимулировать обсуждение, а не пересказать пост."
)

# Промпт для ответов на комментарии пользователей
REPLY_SYSTEM_PROMPT = (
    "Вы бот-администратор в телеграм-канале 'Я-Инженер'. "
    "Вы отвечаете на комментарии подписчиков к постам в канале на русском языке.\n\n"
    
    "Принципы ответа на комментарии:\n\n"
    
    "1. Будьте вежливы, дружелюбны и профессиональны. Обращайтесь на 'Вы'.\n\n"
    
    "2. Поддерживайте естественное развитие диалога:\n"
    "- Помните о теме оригинального поста, но не требуйте строгого придерживания темы\n"
    "- Разрешайте естественные отклонения и развитие обсуждения\n"
    "- Если комментарий связан с темой поста (даже косвенно) — отвечайте на него\n"
    "- Если комментарий задает уточняющие вопросы или развивает тему — поддерживайте диалог\n"
    "- Возвращайте к теме поста ТОЛЬКО если обсуждение полностью ушло в сторону и не связано с исходной темой\n"
    "- Примеры естественного развития диалога:\n"
    "  * Если пост о проектировании, а пользователь спрашивает о материалах — это нормально, отвечайте\n"
    "  * Если пост о технологии, а пользователь делится похожим опытом — поддерживайте обсуждение\n"
    "  * Если пост о безопасности, а пользователь задает вопрос о смежной теме — отвечайте, это расширяет обсуждение\n\n"
    
    "3. Учитывайте контекст и тип комментария:\n"
    "- Если пользователь задал вопрос (по теме или смежной) — дайте краткий, но информативный ответ\n"
    "- Если пользователь высказал мнение — отреагируйте на него, согласитесь или вежливо предложите альтернативный взгляд\n"
    "- Если пользователь поделился опытом — поблагодарите и, возможно, задайте уточняющий вопрос\n"
    "- Если комментарий содержит ошибку — вежливо укажите на неё и предложите правильную информацию\n"
    "- Если комментарий задает вопрос, не связанный с темой — можно ответить кратко, но не обязательно возвращать к теме\n\n"
    
    "4. Структура ответа (не более 500 знаков):\n"
    "- Краткое признание комментария пользователя (если уместно)\n"
    "- Ваш ответ/мнение/информация\n"
    "- Опционально: вопрос для продолжения обсуждения\n\n"
    
    "5. Стиль общения:\n"
    "- Естественный, живой язык (но профессиональный)\n"
    "- Избегайте формальностей и шаблонных фраз\n"
    "- Можно использовать 1-2 эмодзи для дружелюбности (но не переборщите)\n"
    "- Будьте конкретны, избегайте общих фраз\n"
    "- Будьте гибкими и открытыми к развитию диалога\n\n"
    
    "6. Примеры хороших ответов:\n"
    "- На вопрос по теме: 'Спасибо за вопрос! Да, это действительно работает так. Более того, в практике часто встречается...'\n"
    "- На мнение: 'Интересная точка зрения! Согласен, что это важный аспект. Также стоит учесть...'\n"
    "- На опыт: 'Спасибо, что поделились опытом! Это ценно. А как вы решали проблему с...?'\n"
    "- На смежную тему: 'Хороший вопрос! Это связано с тем, что мы обсуждали. В контексте...'\n"
    "- На полностью оффтопик (только в крайнем случае): 'Интересная тема! Но давайте вернемся к обсуждению [тема поста]. Что вы думаете о [аспект темы поста]?'\n\n"
    
    "7. Избегайте:\n"
    "- Слишком длинных ответов (максимум 500 знаков)\n"
    "- Повторения информации из поста\n"
    "- Агрессивного или снисходительного тона\n"
    "- Избыточного количества эмодзи\n"
    "- Слишком строгого придерживания темы (разрешайте естественное развитие диалога)\n"
    "- Постоянного возврата к теме (делайте это только если обсуждение полностью ушло в сторону)\n\n"
    
    "Цель — поддержать конструктивное и живое обсуждение, показать, что комментарии пользователей важны, "
    "и создать комфортную атмосферу для диалога. Тема поста — это отправная точка, но не жесткие рамки."
)


class CommentService:
    """Сервис для генерации комментариев через AI."""

    def __init__(self, openai_client: OpenAI):
        """
        Инициализация сервиса.

        :param openai_client: Клиент OpenAI
        """
        self.openai_client = openai_client
        # История разговоров для контекста (опционально, можно использовать для более умных ответов)
        self.conversation_history: Dict[int, List[Dict[str, str]]] = {}

    async def generate_post_comment(self, post_content: str, chat_id: Optional[int] = None) -> Optional[str]:
        """
        Генерирует комментарий к посту.

        :param post_content: Содержимое поста (текст + обработанный контент)
        :param chat_id: ID чата для истории разговора (опционально)
        :return: Сгенерированный комментарий или None при ошибке
        """
        try:
            # Формируем сообщения для API
            messages = [
                {"role": "system", "content": COMMENT_SYSTEM_PROMPT},
                {"role": "user", "content": post_content}
            ]

            # Если есть история разговора, добавляем её (для контекста)
            if chat_id and chat_id in self.conversation_history:
                # Берем последние N сообщений из истории для контекста
                history = self.conversation_history[chat_id][-MAX_MESSAGES_PER_CHAT:]
                messages = [{"role": "system", "content": COMMENT_SYSTEM_PROMPT}] + history + [
                    {"role": "user", "content": post_content}
                ]

            response = self.openai_client.chat.completions.create(
                model="gpt-4o-mini",
                messages=messages,
                max_tokens=1000,  # Ограничение для комментариев
                temperature=0.7,
            )

            comment = response.choices[0].message.content

            # Сохраняем в историю с ограничениями
            if chat_id:
                self._manage_conversation_history(chat_id)
                if chat_id not in self.conversation_history:
                    self.conversation_history[chat_id] = []
                self.conversation_history[chat_id].append({"role": "user", "content": post_content})
                self.conversation_history[chat_id].append({"role": "assistant", "content": comment})
                # Ограничиваем количество сообщений в истории
                if len(self.conversation_history[chat_id]) > MAX_MESSAGES_PER_CHAT * 2:  # *2 т.к. user + assistant
                    self.conversation_history[chat_id] = self.conversation_history[chat_id][-MAX_MESSAGES_PER_CHAT * 2:]

            return comment
        except Exception as e:
            logger.error(f"Ошибка при генерации комментария к посту: {e}")
            return None

    async def generate_reply_to_comment(
        self,
        user_comment: str,
        original_post_content: Optional[str] = None,
        chat_id: Optional[int] = None
    ) -> Optional[str]:
        """
        Генерирует ответ на комментарий пользователя.

        :param user_comment: Комментарий пользователя
        :param original_post_content: Содержимое оригинального поста (для контекста)
        :param chat_id: ID чата для истории разговора (опционально)
        :return: Сгенерированный ответ или None при ошибке
        """
        try:
            # Формируем контекст для ответа
            user_message = user_comment
            if original_post_content:
                user_message = f"Пост: {original_post_content}\n\nКомментарий пользователя: {user_comment}"

            messages = [
                {"role": "system", "content": REPLY_SYSTEM_PROMPT},
                {"role": "user", "content": user_message}
            ]

            response = self.openai_client.chat.completions.create(
                model="gpt-4o-mini",
                messages=messages,
                max_tokens=300,  # Более короткие ответы на комментарии
                temperature=0.7,
            )

            reply = response.choices[0].message.content

            # Сохраняем в историю с ограничениями
            if chat_id:
                self._manage_conversation_history(chat_id)
                if chat_id not in self.conversation_history:
                    self.conversation_history[chat_id] = []
                self.conversation_history[chat_id].append({"role": "user", "content": user_comment})
                self.conversation_history[chat_id].append({"role": "assistant", "content": reply})
                # Ограничиваем количество сообщений в истории
                if len(self.conversation_history[chat_id]) > MAX_MESSAGES_PER_CHAT * 2:  # *2 т.к. user + assistant
                    self.conversation_history[chat_id] = self.conversation_history[chat_id][-MAX_MESSAGES_PER_CHAT * 2:]

            return reply
        except Exception as e:
            logger.error(f"Ошибка при генерации ответа на комментарий: {e}")
            return None

    def _manage_conversation_history(self, chat_id: int):
        """
        Управляет историей разговоров: ограничивает количество чатов и очищает старые.
        
        :param chat_id: ID текущего чата
        """
        # Если превышен лимит чатов, удаляем самый старый (FIFO)
        if len(self.conversation_history) >= MAX_CONVERSATION_HISTORY_CHATS:
            if chat_id not in self.conversation_history:
                # Удаляем первый (самый старый) чат
                oldest_chat_id = next(iter(self.conversation_history))
                del self.conversation_history[oldest_chat_id]
                logger.debug(f"Удалена история для чата {oldest_chat_id} (превышен лимит {MAX_CONVERSATION_HISTORY_CHATS} чатов)")

    def clear_history(self, chat_id: int):
        """
        Очищает историю разговора для конкретного чата.

        :param chat_id: ID чата
        """
        if chat_id in self.conversation_history:
            del self.conversation_history[chat_id]

    def clear_all_history(self):
        """Очищает всю историю разговоров."""
        self.conversation_history.clear()
