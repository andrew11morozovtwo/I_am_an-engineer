"""
–°–µ—Ä–≤–∏—Å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ —á–µ—Ä–µ–∑ AI.

–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –ø–æ—Å—Ç–∞–º –∏ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
"""
import logging
from typing import Optional, Dict, List
from openai import OpenAI

logger = logging.getLogger(__name__)

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
COMMENT_SYSTEM_PROMPT = (
    "–í—ã –±–æ—Ç-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≤ —Ç–µ–ª–µ–≥—Ä–∞–º-–∫–∞–Ω–∞–ª–µ '–Ø-–ò–Ω–∂–µ–Ω–µ—Ä'. –í–∞—à–∞ –∑–∞–¥–∞—á–∞ ‚Äî –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç—ã –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. "
    "–§–æ—Ä–º–∏—Ä—É–π—Ç–µ –∫—Ä–∞—Ç–∫–∏–π (–Ω–µ –±–æ–ª–µ–µ 3000 –∑–Ω–∞–∫–æ–≤) –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, "
    "–æ—Ä–∏–µ–Ω—Ç–∏—Ä—É—è—Å—å –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:\n\n"
    "1. –ü—Ä–æ—á–∏—Ç–∞–π—Ç–µ –ø–æ—Å—Ç. –ï—Å–ª–∏ –≤ –ø–æ—Å—Ç–µ —É–∫–∞–∑–∞–Ω–∞ —Å—Å—ã–ª–∫–∞, –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏—Ç–µ, —á—Ç–æ –æ–Ω–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. "
    "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ —Ç–µ–º–µ, –∏–∑–ª–æ–∂–µ–Ω–Ω–æ–π –≤ –ø–æ—Å—Ç–µ, –∞ —Ç–∞–∫–∂–µ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞—Ö.\n"
    "2. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ñ–æ—Ä–º–ª—è–π—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ:\n"
    "- –í–≤–µ–¥–µ–Ω–∏–µ: –∫—Ä–∞—Ç–∫–æ –æ–±—ä—è—Å–Ω–∏—Ç–µ, –æ —á–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª –∏ –ø–æ—á–µ–º—É –æ–Ω –≤–∞–∂–µ–Ω.\n"
    "- –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å: –∏–∑–ª–æ–∂–∏—Ç–µ –∫–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º, –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞—è —Å—É—Ç—å. –†–∞–∑–¥–µ–ª—è–π—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∞ –∞–±–∑–∞—Ü—ã.\n"
    "- –ó–∞–∫–ª—é—á–µ–Ω–∏–µ: —Å–¥–µ–ª–∞–π—Ç–µ –≤—ã–≤–æ–¥—ã, –ø—Ä–µ–¥–ª–æ–∂–∏—Ç–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏–ª–∏ –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –¥–ª—è –≤–æ–≤–ª–µ—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤.\n"
    "3. –ï—Å–ª–∏ –ø–æ—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ —Å—Å—ã–ª–∫—É, —Å–æ—Å—Ç–∞–≤—å—Ç–µ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π –ø–µ—Ä–µ—Å–∫–∞–∑ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–±—â–µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. "
    "–£–∫–∞–∂–∏—Ç–µ, —á—Ç–æ –ø–µ—Ä–µ—Å–∫–∞–∑ –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏.\n"
    "4. –£–∫–∞–∑—ã–≤–∞–π—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –∫–æ–Ω—Ü–µ —Ç–µ–∫—Å—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: '–ò—Å—Ç–æ—á–Ω–∏–∫: —Å—Å—ã–ª–∫–∞ –∏–∑ –ø–æ—Å—Ç–∞').\n\n"
    "–û–±—â–∞–π—Ç–µ—Å—å —Å —á–∏—Ç–∞—Ç–µ–ª—è–º–∏ –≤–µ–∂–ª–∏–≤–æ, –æ—Ç –º—É–∂—Å–∫–æ–≥–æ –ª–∏—Ü–∞, –∏—Å–ø–æ–ª—å–∑—É—è '–í—ã'.\n\n"
    "–í–∫–ª—é—á–∞–π—Ç–µ —ç–º–æ–¥–∑–∏ –¥–ª—è –∞–∫—Ü–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤, —Ç–∞–∫–∏—Ö –∫–∞–∫:\n"
    "- üîç –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –≤–∞–∂–Ω—ã—Ö –¥–µ—Ç–∞–ª–µ–π,\n"
    "- üìå –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö —Ç–µ–∑–∏—Å–æ–≤,\n"
    "- üåü –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.\n\n"
    "–°–ª–µ–¥–∏—Ç–µ –∑–∞ —Ç–µ–º, —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –±—ã–ª –ª–µ–≥–∫–æ —á–∏—Ç–∞–µ–º –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –∏ –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω —ç–º–æ–¥–∑–∏. "
    "–°—Ç–∞—Ä–∞–π—Ç–µ—Å—å —Å–æ–∑–¥–∞–≤–∞—Ç—å —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, —á—Ç–æ–±—ã –ø–æ–¥–ø–∏—Å—á–∏–∫–∏ –∑–∞—Ö–æ—Ç–µ–ª–∏ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª."
)

# –ü—Ä–æ–º–ø—Ç –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
REPLY_SYSTEM_PROMPT = (
    "–í—ã –±–æ—Ç-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≤ —Ç–µ–ª–µ–≥—Ä–∞–º-–∫–∞–Ω–∞–ª–µ '–Ø-–ò–Ω–∂–µ–Ω–µ—Ä'. "
    "–í—ã –æ—Ç–≤–µ—á–∞–µ—Ç–µ –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –∫ –ø–æ—Å—Ç–∞–º –≤ –∫–∞–Ω–∞–ª–µ. "
    "–í–∞—à–∞ –∑–∞–¥–∞—á–∞ ‚Äî –¥–∞—Ç—å –∫—Ä–∞—Ç–∫–∏–π, –≤–µ–∂–ª–∏–≤—ã–π –∏ –ø–æ–ª–µ–∑–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. "
    "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫, –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –Ω–∞ '–í—ã'. "
    "–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –±–æ–ª–µ–µ 500 –∑–Ω–∞–∫–æ–≤, –ø–æ –¥–µ–ª—É –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º."
)


class CommentService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ —á–µ—Ä–µ–∑ AI."""

    def __init__(self, openai_client: OpenAI):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞.

        :param openai_client: –ö–ª–∏–µ–Ω—Ç OpenAI
        """
        self.openai_client = openai_client
        # –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –±–æ–ª–µ–µ —É–º–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤)
        self.conversation_history: Dict[int, List[Dict[str, str]]] = {}

    async def generate_post_comment(self, post_content: str, chat_id: Optional[int] = None) -> Optional[str]:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –ø–æ—Å—Ç—É.

        :param post_content: –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–æ—Å—Ç–∞ (—Ç–µ–∫—Å—Ç + –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç)
        :param chat_id: ID —á–∞—Ç–∞ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        :return: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏–ª–∏ None –ø—Ä–∏ –æ—à–∏–±–∫–µ
        """
        try:
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è API
            messages = [
                {"role": "system", "content": COMMENT_SYSTEM_PROMPT},
                {"role": "user", "content": post_content}
            ]

            # –ï—Å–ª–∏ –µ—Å—Ç—å –∏—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞, –¥–æ–±–∞–≤–ª—è–µ–º –µ—ë (–¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
            if chat_id and chat_id in self.conversation_history:
                # –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
                history = self.conversation_history[chat_id][-5:]
                messages = [{"role": "system", "content": COMMENT_SYSTEM_PROMPT}] + history + [
                    {"role": "user", "content": post_content}
                ]

            response = self.openai_client.chat.completions.create(
                model="gpt-4o-mini",
                messages=messages,
                max_tokens=1000,  # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
                temperature=0.7,
            )

            comment = response.choices[0].message.content

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
            if chat_id:
                if chat_id not in self.conversation_history:
                    self.conversation_history[chat_id] = []
                self.conversation_history[chat_id].append({"role": "user", "content": post_content})
                self.conversation_history[chat_id].append({"role": "assistant", "content": comment})

            return comment
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –∫ –ø–æ—Å—Ç—É: {e}")
            return None

    async def generate_reply_to_comment(
        self,
        user_comment: str,
        original_post_content: Optional[str] = None,
        chat_id: Optional[int] = None
    ) -> Optional[str]:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

        :param user_comment: –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        :param original_post_content: –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –ø–æ—Å—Ç–∞ (–¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
        :param chat_id: ID —á–∞—Ç–∞ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        :return: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –∏–ª–∏ None –ø—Ä–∏ –æ—à–∏–±–∫–µ
        """
        try:
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–≤–µ—Ç–∞
            user_message = user_comment
            if original_post_content:
                user_message = f"–ü–æ—Å—Ç: {original_post_content}\n\n–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_comment}"

            messages = [
                {"role": "system", "content": REPLY_SYSTEM_PROMPT},
                {"role": "user", "content": user_message}
            ]

            response = self.openai_client.chat.completions.create(
                model="gpt-4o-mini",
                messages=messages,
                max_tokens=300,  # –ë–æ–ª–µ–µ –∫–æ—Ä–æ—Ç–∫–∏–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                temperature=0.7,
            )

            reply = response.choices[0].message.content

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
            if chat_id:
                if chat_id not in self.conversation_history:
                    self.conversation_history[chat_id] = []
                self.conversation_history[chat_id].append({"role": "user", "content": user_comment})
                self.conversation_history[chat_id].append({"role": "assistant", "content": reply})

            return reply
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: {e}")
            return None

    def clear_history(self, chat_id: int):
        """
        –û—á–∏—â–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —á–∞—Ç–∞.

        :param chat_id: ID —á–∞—Ç–∞
        """
        if chat_id in self.conversation_history:
            del self.conversation_history[chat_id]

    def clear_all_history(self):
        """–û—á–∏—â–∞–µ—Ç –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤."""
        self.conversation_history.clear()
